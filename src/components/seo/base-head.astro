---
import 'src/styles/global.css';
import { SITE_TITLE, TWITTER_HANDLE } from '@data/index';

interface Props {
	title: string;
	description: string;
	image?: string;
	type?: 'website' | 'article';
	publishedTime?: Date;
	modifiedTime?: Date;
	author?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const {
	title,
	description,
	image = '/images/ogimage.png',
	type = 'website',
	publishedTime,
	modifiedTime,
	author = 'Sanju Sivalingam',
} = Astro.props;

const resolvedImage = new URL(image, Astro.url);
const fullTitle = `${title} | sanju`;
---

<!-- Theme detection (before paint) -->
<script is:inline>
	const theme = (() => {
		if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
			return localStorage.getItem('theme') || 'light';
		}
		if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
			return 'dark';
		}
		return 'light';
	})();

	if (theme === 'dark') {
		document.documentElement.classList.add('dark');
	} else {
		document.documentElement.classList.remove('dark');
	}
</script>

<!-- Umami analytics -->{
	import.meta.env.PROD && (
		<script
			defer
			src={import.meta.env.UMAMI_TRACKING_URL}
			data-website-id={import.meta.env.UMAMI_WEBSITE_ID}
		/>
	)
}

<!-- Clarity analytics -->
{
	import.meta.env.PROD && (
		<script
			type='text/javascript'
			set:html={`
			(function(c,l,a,r,i,t,y){
				c[a] = c[a] || function() { (c[a].q=c[a].q||[]).push(arguments) };
				t=l.createElement(r); t.async=1; t.src="https://www.clarity.ms/tag/" + i;
				y=l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t,y);
			})(window, document, "clarity", "script", "${import.meta.env.CLARITY_TRACKING_ID}");
		`}
		/>
	)
}

<link
	rel='sitemap'
	href='/sitemap-index.xml'
/>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">

<!-- Global Metadata -->
<meta charset='utf-8' />
<meta
	name='viewport'
	content='width=device-width,initial-scale=1'
/>

<!-- Favicons -->
<link rel='apple-touch-icon' sizes='57x57' href='/apple-icon-57x57.png' />
<link rel='apple-touch-icon' sizes='60x60' href='/apple-icon-60x60.png' />
<link rel='apple-touch-icon' sizes='72x72' href='/apple-icon-72x72.png' />
<link rel='apple-touch-icon' sizes='76x76' href='/apple-icon-76x76.png' />
<link rel='apple-touch-icon' sizes='114x114' href='/apple-icon-114x114.png' />
<link rel='apple-touch-icon' sizes='120x120' href='/apple-icon-120x120.png' />
<link rel='apple-touch-icon' sizes='144x144' href='/apple-icon-144x144.png' />
<link rel='apple-touch-icon' sizes='152x152' href='/apple-icon-152x152.png' />
<link rel='apple-touch-icon' sizes='180x180' href='/apple-icon-180x180.png' />
<link rel='icon' type='image/png' sizes='192x192' href='/android-icon-192x192.png' />
<link rel='icon' type='image/png' sizes='32x32' href='/favicon-32x32.png' />
<link rel='icon' type='image/png' sizes='96x96' href='/favicon-96x96.png' />
<link rel='icon' type='image/png' sizes='16x16' href='/favicon-16x16.png' />
<link rel='manifest' href='/manifest.json' />
<meta name='msapplication-TileColor' content='#ffffff' />
<meta name='msapplication-TileImage' content='/ms-icon-144x144.png' />
<meta name='theme-color' content='#ffffff' />

<meta name='generator' content={Astro.generator} />

<!-- Canonical URL -->
<link rel='canonical' href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{fullTitle}</title>
<meta name='title' content={fullTitle} />
<meta name='description' content={description} />
<meta name='author' content={author} />

<!-- Open Graph -->
<meta property='og:type' content={type} />
<meta property='og:url' content={Astro.url} />
<meta property='og:title' content={fullTitle} />
<meta property='og:description' content={description} />
<meta property='og:image' content={resolvedImage} />
<meta property='og:site_name' content={SITE_TITLE} />
<meta property='og:locale' content='en_US' />

{type === 'article' && publishedTime && (
	<meta property='article:published_time' content={publishedTime.toISOString()} />
)}
{type === 'article' && modifiedTime && (
	<meta property='article:modified_time' content={modifiedTime.toISOString()} />
)}
{type === 'article' && (
	<meta property='article:author' content={author} />
)}

<!-- Twitter -->
<meta property='twitter:card' content='summary_large_image' />
<meta property='twitter:url' content={Astro.url} />
<meta property='twitter:title' content={fullTitle} />
<meta property='twitter:description' content={description} />
<meta property='twitter:image' content={resolvedImage} />
<meta property='twitter:site' content={TWITTER_HANDLE} />
<meta property='twitter:creator' content={TWITTER_HANDLE} />

<!-- RSS -->
<link
	rel='alternate'
	type='application/rss+xml'
	title={`${SITE_TITLE} RSS Feed`}
	href={new URL('rss.xml', Astro.site)}
/>

<!-- JSON-LD Structured Data -->
{type === 'website' ? (
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "WebSite",
		"name": SITE_TITLE,
		"url": Astro.site?.toString(),
		"description": description,
		"author": {
			"@type": "Person",
			"name": "Sanju Sivalingam",
			"url": Astro.site?.toString(),
			"sameAs": [
				"https://x.com/spikeysanju",
				"https://github.com/spikeysanju",
				"https://www.linkedin.com/in/imsanju"
			]
		}
	})} />
) : (
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "Article",
		"headline": title,
		"description": description,
		"image": resolvedImage.toString(),
		"url": canonicalURL.toString(),
		"datePublished": publishedTime?.toISOString(),
		"dateModified": (modifiedTime ?? publishedTime)?.toISOString(),
		"author": {
			"@type": "Person",
			"name": "Sanju Sivalingam",
			"url": Astro.site?.toString()
		},
		"publisher": {
			"@type": "Person",
			"name": "Sanju Sivalingam",
			"url": Astro.site?.toString()
		},
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": canonicalURL.toString()
		}
	})} />
)}
